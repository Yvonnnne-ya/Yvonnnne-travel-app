<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tripy ğŸ±</title>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/4.1.0/vuedraggable.umd.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#fcfaf2; }
.theme-yellow { color:#FAAC68; }
.bg-theme-yellow { background:#FAAC68; }
.glass-card { background:rgba(255,255,255,.9); border-radius:20px; }
.tab-active { border-bottom:3px solid #FAAC68; color:#FAAC68; font-weight:bold; }
.drag-handle { cursor:grab; color:#ccc; }
input[type="date"] { font-size:12px; color:#9ca3af; }
.itinerary-container { display:flex; overflow-x:auto; gap:16px; }
.itinerary-card { min-width:85%; }
</style>
</head>

<body>
<div id="app" class="max-w-md mx-auto min-h-screen bg-white/60">

<!-- Loading -->
<div v-if="loading" class="fixed inset-0 flex items-center justify-center bg-white/80 z-50">
    <i class="fas fa-cat fa-bounce text-5xl theme-yellow"></i>
</div>

<!-- ===== é¦–é  ===== -->
<div v-if="!currentTrip" class="p-6">
<header class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-black theme-yellow">Tripy</h1>
    <button @click="addNewTrip" class="bg-theme-yellow text-white w-10 h-10 rounded-full">
        <i class="fas fa-plus"></i>
    </button>
</header>

<div class="space-y-4">
<div v-for="(trip, index) in trips" :key="trip.firebaseId" class="glass-card p-4 relative">

<!-- ğŸ”§ ä¿®å¾©é‡é»ï¼šç„¡ overlayï¼Œinput å€å¡Š stop -->
<div @click="viewTrip(trip)">
    <input v-model="trip.title"
           @input="updateTripInList(trip)"
           class="text-lg font-bold w-full bg-transparent outline-none"/>

    <div class="flex gap-1 mt-2 items-center" @click.stop>
        <input type="date" v-model="trip.startDate" @change="updateTripInList(trip)">
        <span>-</span>
        <input type="date" v-model="trip.endDate" @change="updateTripInList(trip)">
    </div>
</div>

<button @click.stop="deleteTrip(index)"
        class="absolute top-3 right-3 text-gray-300 hover:text-red-400">
    <i class="fas fa-trash"></i>
</button>
</div>
</div>
</div>

<!-- ===== å…§é  ===== -->
<div v-else class="p-4">
<nav class="flex items-center mb-4">
<button @click="saveAndExit"><i class="fas fa-chevron-left"></i></button>
<input v-model="currentTrip.title"
       class="flex-1 text-center font-bold bg-transparent outline-none"/>
</nav>

<div class="flex justify-around mb-4">
<button v-for="t in tabs"
        :key="t.id"
        @click="activeTab=t.id"
        :class="activeTab===t.id?'tab-active':''">
{{t.name}}
</button>
</div>

<!-- Checklist -->
<div v-if="activeTab==='checklist'" class="space-y-4">
<div v-for="type in ['shopping','packing']" :key="type" class="bg-white p-4 rounded">
<h3 class="font-bold">{{type}}</h3>

<div v-for="(item,i) in currentTrip[type]" :key="item.id" class="flex gap-2">
<input type="checkbox" v-model="item.done">
<input v-model="item.text" class="flex-1">
<button @click="removeItem(type,i)">x</button>
</div>

<button @click="addItem(type)" class="text-xs theme-yellow">+ æ–°å¢</button>
</div>
</div>

<!-- Expense -->
<div v-if="activeTab==='expense'">
<div v-for="(e,i) in currentTrip.expenses" :key="e.id" class="flex gap-2">
<input v-model="e.name" class="flex-1">
<input type="number" v-model.number="e.amount" class="w-20">
<button @click="removeItem('expenses',i)">x</button>
</div>
<button @click="addItem('expenses')" class="theme-yellow">+ æ–°å¢æ”¯å‡º</button>
</div>

<!-- Itinerary -->
<div v-if="activeTab==='itinerary'" class="itinerary-container">
<div v-for="(day,d) in currentTrip.schedule" :key="d" class="itinerary-card bg-white p-4">
<h4>Day {{d+1}}</h4>
<input type="date" v-model="day.date">

<div v-for="(it,i) in day.items" :key="it.id">
<textarea v-model="it.desc"></textarea>
<button @click="day.items.splice(i,1);updateTripInList(currentTrip)">x</button>
</div>

<button @click="addDayItem(d)">+ è¡Œç¨‹é»</button>
<button @click="removeItem('schedule',d)">åˆªé™¤æ­¤æ—¥</button>
</div>

<button @click="addItem('schedule')" class="min-w-[80%] border-dashed border p-6">
+ æ–°å¢ä¸€å¤©
</button>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyDNQ41J2u6V32w5OP7y49TLKXoWRRASSik",
authDomain:"tripy-275a7.firebaseapp.com",
projectId:"tripy-275a7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const { createApp, ref, computed, onMounted } = Vue;

createApp({
components:{ draggable:window.vuedraggable },
setup(){
const trips=ref([]);
const currentTrip=ref(null);
const loading=ref(false);
const activeTab=ref('checklist');
const tabs=[
{id:'checklist',name:'æº–å‚™'},
{id:'expense',name:'è¨˜å¸³'},
{id:'itinerary',name:'è¡Œç¨‹'}
];

const fetchTrips=async()=>{
const q=await getDocs(collection(db,'trips'));
trips.value=q.docs.map(d=>({firebaseId:d.id,...d.data()}));
};

const updateTripInList=async(trip)=>{
const refDoc=doc(db,'trips',trip.firebaseId);
const data={...trip};
delete data.firebaseId;
await updateDoc(refDoc,data);
};

const addNewTrip=async()=>{
const title=prompt('æ—…ç¨‹åç¨±');
if(!title)return;
const data={
title,startDate:'',endDate:'',
shopping:[],packing:[],expenses:[],
schedule:[{date:'',items:[]}],note:''
};
const r=await addDoc(collection(db,'trips'),data);
trips.value.push({firebaseId:r.id,...data});
};

const viewTrip=(trip)=>{
currentTrip.value=JSON.parse(JSON.stringify(trip));
};

const saveAndExit=async()=>{
await updateTripInList(currentTrip.value);
currentTrip.value=null;
fetchTrips();
};

const addItem=(type)=>{
const id=Date.now().toString();
if(type==='schedule'){
currentTrip.value.schedule.push({date:'',items:[]});
}else{
currentTrip.value[type].push(
type==='expenses'?{id,name:'',amount:0}:{id,text:'',done:false}
);
}
updateTripInList(currentTrip.value);
};

const addDayItem=(i)=>{
currentTrip.value.schedule[i].items.push({id:Date.now().toString(),desc:''});
updateTripInList(currentTrip.value);
};

const removeItem=(type,i)=>{
currentTrip.value[type].splice(i,1);
updateTripInList(currentTrip.value);
};

const deleteTrip=async(i)=>{
await deleteDoc(doc(db,'trips',trips.value[i].firebaseId));
trips.value.splice(i,1);
};

onMounted(fetchTrips);

return{
trips,currentTrip,loading,activeTab,tabs,
addNewTrip,viewTrip,saveAndExit,
addItem,addDayItem,removeItem,
deleteTrip,updateTripInList
};
}
}).mount('#app');
</script>
</body>
</html>
