<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tripy - ä½ çš„æ—…éŠå°åŠ©æ‰‹ ğŸ±</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fdf2f8; color: #4a4a4a; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 24px; border: 1px solid rgba(255, 192, 203, 0.3); }
        .tab-active { border-bottom: 3px solid #f472b6; color: #db2777; font-weight: bold; }
        .safe-area-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
    </style>
</head>
<body>
    <div id="app" class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-white/30">
        
        <div v-if="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-pink-50/80">
            <i class="fas fa-cat fa-bounce text-pink-400 text-5xl mb-4"></i>
            <p class="text-pink-600 font-medium tracking-widest">å°è²“æ­£åœ¨æ¬è³‡æ–™...ğŸ¾</p>
        </div>

        <div v-if="!currentTrip" class="p-6">
            <header class="flex justify-between items-center mb-10 mt-4">
                <div>
                    <h1 class="text-4xl font-extrabold text-pink-500 tracking-tighter">Tripy</h1>
                    <p class="text-pink-300 text-sm font-medium">é™ªä½ èµ°éä¸–ç•Œçš„å°è²“ ğŸ¾</p>
                </div>
                <button @click="addNewTrip" class="bg-pink-500 text-white w-14 h-14 rounded-2xl shadow-lg hover:rotate-12 transition-transform flex items-center justify-center">
                    <i class="fas fa-plus text-xl"></i>
                </button>
            </header>

            <div class="space-y-5">
                <div v-for="trip in trips" :key="trip.id" class="glass-card p-6 shadow-sm hover:shadow-md transition-shadow relative">
                    <div @click="viewTrip(trip)" class="cursor-pointer">
                        <h3 class="text-xl font-bold text-gray-800">{{ trip.title }}</h3>
                        <p class="text-gray-400 text-sm mt-2 flex items-center">
                            <i class="far fa-calendar-check mr-2"></i>{{ trip.date }}
                        </p>
                    </div>
                    <button @click.stop="duplicateTrip(trip)" class="absolute top-6 right-6 text-pink-200 hover:text-pink-500 transition-colors">
                        <i class="far fa-copy text-lg"></i>
                    </button>
                </div>
                
                <div v-if="trips.length === 0" class="text-center py-20">
                    <i class="fas fa-paw text-pink-100 text-6xl mb-4"></i>
                    <p class="text-gray-400">ç›®å‰æ²’æœ‰è¡Œç¨‹ï¼Œå¿«é»æ“Šä¸Šæ–¹ + è™Ÿå§ï¼</p>
                </div>
            </div>
        </div>

        <div v-else class="min-h-screen bg-gray-50 flex flex-col">
            <nav class="bg-white p-5 flex items-center sticky top-0 z-10 shadow-sm">
                <button @click="saveAndExit" class="text-gray-400 hover:text-pink-500 p-2"><i class="fas fa-arrow-left text-lg"></i></button>
                <h2 class="text-lg font-bold flex-1 text-center truncate px-4">{{ currentTrip.title }}</h2>
                <div class="w-10 text-pink-400 text-center"><i class="fas fa-cat"></i></div>
            </nav>

            <div class="flex justify-around bg-white border-b text-sm">
                <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id" 
                    :class="['py-4 px-2 w-full transition-all', activeTab === tab.id ? 'tab-active' : 'text-gray-400']">
                    {{ tab.name }}
                </button>
            </div>

            <div class="flex-1 p-6 overflow-y-auto safe-area-bottom">
                <div v-if="activeTab === 'checklist'" class="space-y-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm">
                        <h4 class="font-bold mb-4 flex items-center text-gray-700">ğŸ›’ è³¼ç‰©æ¸…å–®</h4>
                        <div v-for="(item, idx) in currentTrip.shopping" :key="idx" class="flex items-center mb-4 group">
                            <input type="checkbox" v-model="item.done" class="w-6 h-6 rounded-lg border-pink-200 text-pink-500 focus:ring-pink-300 mr-3">
                            <span :class="item.done ? 'line-through text-gray-300' : 'text-gray-600'">{{ item.text }}</span>
                        </div>
                        <button @click="addItem('shopping')" class="mt-2 text-pink-400 text-sm font-medium hover:text-pink-600">+ æ–°å¢è³¼ç‰©é …ç›®</button>
                    </div>
                    
                    <div class="bg-white p-6 rounded-3xl shadow-sm">
                        <h4 class="font-bold mb-4 flex items-center text-gray-700">ğŸ’ å¿…å¸¶ç‰©å“</h4>
                        <div v-for="(item, idx) in currentTrip.packing" :key="idx" class="flex items-center mb-4">
                            <input type="checkbox" v-model="item.done" class="w-6 h-6 rounded-lg border-pink-200 text-pink-500 focus:ring-pink-300 mr-3">
                            <span :class="item.done ? 'line-through text-gray-300' : 'text-gray-600'">{{ item.text }}</span>
                        </div>
                        <button @click="addItem('packing')" class="mt-2 text-pink-400 text-sm font-medium hover:text-pink-600">+ æ–°å¢è¡Œæé …ç›®</button>
                    </div>
                </div>

                <div v-if="activeTab === 'expense'" class="space-y-4">
                    <div class="bg-pink-500 p-8 rounded-[40px] text-white shadow-xl shadow-pink-100">
                        <p class="text-pink-100 text-sm font-medium">æ—…è¡Œç¸½æ”¯å‡º</p>
                        <p class="text-4xl font-black mt-2">NT$ {{ totalExpense }}</p>
                    </div>
                    <div class="bg-white rounded-3xl p-4 shadow-sm">
                        <div v-for="(exp, idx) in currentTrip.expenses" :key="idx" class="flex justify-between items-center p-4 border-b border-gray-50 last:border-0">
                            <span class="text-gray-600">{{ exp.name }}</span>
                            <span class="font-bold text-gray-800">$ {{ exp.amount }}</span>
                        </div>
                        <button @click="addItem('expenses')" class="w-full py-4 mt-2 text-pink-400 text-sm font-bold border-2 border-dashed border-pink-50 rounded-2xl hover:bg-pink-50 transition">+ è¨˜ä¸€ç­†æ”¯å‡º</button>
                    </div>
                </div>

                <div v-if="activeTab === 'itinerary'" class="space-y-4">
                    <div class="bg-blue-500 p-6 rounded-3xl text-white shadow-lg shadow-blue-100">
                        <h4 class="font-bold mb-3 flex items-center"><i class="fas fa-plane-departure mr-2"></i>äº¤é€šèˆ‡ä½å®¿</h4>
                        <div class="space-y-2 opacity-90 text-sm">
                            <p class="flex justify-between border-b border-white/20 pb-2"><span>èˆªç­</span><input v-model="currentTrip.flight" class="bg-transparent text-right outline-none placeholder-white/50" placeholder="é»æ“Šå¡«å¯«"></p>
                            <p class="flex justify-between"><span>ä½å®¿</span><input v-model="currentTrip.hotel" class="bg-transparent text-right outline-none placeholder-white/50" placeholder="é»æ“Šå¡«å¯«"></p>
                        </div>
                    </div>
                    <div v-for="(day, index) in currentTrip.schedule" :key="index" class="bg-white p-5 rounded-2xl border-l-4 border-pink-400 shadow-sm">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-black text-pink-500 uppercase tracking-widest">Day {{ index + 1 }}</span>
                            <input v-model="day.date" class="text-xs text-gray-400 text-right outline-none bg-transparent">
                        </div>
                        <textarea v-model="day.plan" class="w-full mt-2 text-gray-700 font-medium outline-none resize-none bg-transparent" rows="2" placeholder="ä»Šå¤©è¦å»å“ªè£¡ç©ï¼Ÿ"></textarea>
                    </div>
                    <button @click="addItem('schedule')" class="w-full py-3 text-gray-400 text-sm">+ å¢åŠ å¤©æ•¸</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase å¼•å…¥
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ä½¿ç”¨ä½ æä¾›çš„ Config
        const firebaseConfig = {
            apiKey: "AIzaSyDNQ41J2u6V32w5OP7y49TLKXoWRRASSik",
            authDomain: "tripy-275a7.firebaseapp.com",
            projectId: "tripy-275a7",
            storageBucket: "tripy-275a7.firebasestorage.app",
            messagingSenderId: "1063817586690",
            appId: "1:1063817586690:web:ee84458b2373cd4b20df1b",
            measurementId: "G-SEPL6BEGZL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const trips = ref([]);
                const currentTrip = ref(null);
                const loading = ref(true);
                const activeTab = ref('checklist');
                const tabs = [
                    { id: 'checklist', name: 'æº–å‚™' },
                    { id: 'expense', name: 'è¨˜å¸³' },
                    { id: 'itinerary', name: 'è¡Œç¨‹' }
                ];

                // 1. å¾é›²ç«¯æŠ“å–è³‡æ–™ (Read)
                const fetchTrips = async () => {
                    loading.value = true;
                    try {
                        const querySnapshot = await getDocs(collection(db, "trips"));
                        trips.value = querySnapshot.docs.map(doc => ({
                            firebaseId: doc.id,
                            ...doc.data()
                        }));
                    } catch (e) {
                        console.error("è®€å–å¤±æ•—:", e);
                    }
                    loading.value = false;
                };

                // 2. æ–°å¢è¡Œç¨‹ (Create)
                const addNewTrip = async () => {
                    const title = prompt("é€™è¶Ÿæ—…è¡Œè¦å»å“ªè£¡ï¼Ÿ(ä¾‹å¦‚ï¼šæ±äº¬ 5 æ—¥éŠ)");
                    if (!title) return;
                    
                    const newTrip = {
                        title: title,
                        date: new Date().toLocaleDateString(),
                        shopping: [{text: 'éš¨èº«è—¥å“', done: false}],
                        packing: [{text: 'è­·ç…§', done: false}],
                        expenses: [],
                        flight: '',
                        hotel: '',
                        schedule: [{date: 'ç¬¬ä¸€å¤©', plan: ''}]
                    };

                    const docRef = await addDoc(collection(db, "trips"), newTrip);
                    trips.value.push({ firebaseId: docRef.id, ...newTrip });
                };

                // 3. å„²å­˜è®Šæ›´ (Update) - ç•¶æŒ‰è¿”å›æ™‚è§¸ç™¼
                const saveAndExit = async () => {
                    if (currentTrip.value && currentTrip.value.firebaseId) {
                        loading.value = true;
                        const tripRef = doc(db, "trips", currentTrip.value.firebaseId);
                        const rawData = { ...currentTrip.value };
                        delete rawData.firebaseId; // ä¸å„²å­˜ ID æ¬„ä½å›å…§å®¹
                        
                        await updateDoc(tripRef, rawData);
                    }
                    currentTrip.value = null;
                    loading.value = false;
                };

                // 4. è¤‡è£½è¡Œç¨‹ (Duplicate)
                const duplicateTrip = async (trip) => {
                    loading.value = true;
                    const clonedData = JSON.parse(JSON.stringify(trip));
                    delete clonedData.firebaseId;
                    clonedData.title = `${trip.title} (è¤‡è£½å“)`;
                    
                    const docRef = await addDoc(collection(db, "trips"), clonedData);
                    trips.value.push({ firebaseId: docRef.id, ...clonedData });
                    loading.value = false;
                };

                // é€šç”¨æ–°å¢é …ç›®çš„æç¤ºçª—
                const addItem = (type) => {
                    if (type === 'shopping') {
                        const text = prompt("è¦è²·ä»€éº¼ï¼Ÿ");
                        if(text) currentTrip.value.shopping.push({text, done: false});
                    } else if (type === 'packing') {
                        const text = prompt("å¿…å¸¶ç‰©å“åç¨±ï¼Ÿ");
                        if(text) currentTrip.value.packing.push({text, done: false});
                    } else if (type === 'expenses') {
                        const name = prompt("æ¶ˆè²»é …ç›®ï¼Ÿ");
                        const amount = parseInt(prompt("æ¶ˆè²»é‡‘é¡ï¼Ÿ"));
                        if(name && !isNaN(amount)) currentTrip.value.expenses.push({name, amount});
                    } else if (type === 'schedule') {
                        currentTrip.value.schedule.push({date: `Day ${currentTrip.value.schedule.length + 1}`, plan: ''});
                    }
                };

                const totalExpense = computed(() => {
                    if (!currentTrip.value) return 0;
                    return currentTrip.value.expenses.reduce((sum, item) => sum + (item.amount || 0), 0);
                });

                const viewTrip = (trip) => {
                    currentTrip.value = trip;
                    activeTab.value = 'checklist';
                };

                onMounted(fetchTrips);

                return { trips, currentTrip, activeTab, tabs, viewTrip, totalExpense, duplicateTrip, addNewTrip, saveAndExit, loading, addItem };
            }
        }).mount('#app');
    </script>
</body>
</html>